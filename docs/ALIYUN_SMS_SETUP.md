# 阿里云短信服务配置指南

## 📋 前置准备

1. **阿里云账号**：确保您已有阿里云账号
2. **实名认证**：账号需要完成实名认证
3. **开通短信服务**：在阿里云控制台开通"短信服务"

---

## 🔧 配置步骤

### 第一步：获取 AccessKey

1. 登录 [阿里云控制台](https://ecs.console.aliyun.com/)
2. 鼠标悬停在右上角头像 → 点击 **"AccessKey管理"**
3. 如果提示需要创建，点击 **"创建AccessKey"**
4. 记录下：
   - **AccessKey ID**（例如：`LTAIxxxxxxxxxxxx`）
   - **AccessKey Secret**（例如：`xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx`）

⚠️ **安全提示**：
- AccessKey Secret 只显示一次，请妥善保管
- 不要将 AccessKey 提交到代码仓库
- 建议创建子账号并分配最小权限

---

### 第二步：开通短信服务

1. 进入 [短信服务控制台](https://dysms.console.aliyun.com/)
2. 如果未开通，点击 **"立即开通"**
3. 完成服务开通（通常需要几分钟）

---

### 第三步：申请短信签名

1. 在短信服务控制台，点击左侧 **"国内消息"** → **"签名管理"**
2. 点击 **"添加签名"**
3. 填写签名信息：
   - **签名名称**：`小红书爆文生成`（或您的产品名称）
   - **签名来源**：选择 **"网站"** 或 **"APP"**
   - **网站/APP名称**：填写您的网站或APP名称
   - **网站/APP地址**：填写您的网站地址或APP下载地址
   - **证明文件**：上传营业执照或APP截图
4. 提交审核（通常 1-2 个工作日）

---

### 第四步：申请短信模板

1. 在短信服务控制台，点击左侧 **"国内消息"** → **"模板管理"**
2. 点击 **"添加模板"**
3. 填写模板信息：
   - **模板名称**：`验证码模板`
   - **模板类型**：选择 **"验证码"**
   - **模板内容**：
     ```
     您的验证码是${code}，5分钟内有效，请勿泄露给他人。
     ```
   - **申请说明**：填写使用场景（例如：用于用户登录验证）
4. 提交审核（通常 1-2 个工作日）

5. 审核通过后，记录下 **模板CODE**（格式：`SMS_123456789`）

---

### 第五步：配置环境变量

在项目的 `.env.local` 文件中添加以下配置：

```bash
# 阿里云短信服务配置
ALIYUN_SMS_ACCESS_KEY_ID=YOUR_ACCESS_KEY_ID
ALIYUN_SMS_ACCESS_KEY_SECRET=YOUR_ACCESS_KEY_SECRET
ALIYUN_SMS_SIGN_NAME=小红书爆文生成
ALIYUN_SMS_TEMPLATE_CODE=SMS_123456789

# 管理员手机号（多个用逗号分隔）
ADMIN_PHONES=13800138000,13900139000
```

**说明**：
- `ALIYUN_SMS_ACCESS_KEY_ID`：您的 AccessKey ID
- `ALIYUN_SMS_ACCESS_KEY_SECRET`：您的 AccessKey Secret
- `ALIYUN_SMS_SIGN_NAME`：短信签名名称（必须与审核通过的签名一致）
- `ALIYUN_SMS_TEMPLATE_CODE`：短信模板 CODE（格式：`SMS_xxxxx`）
- `ADMIN_PHONES`：管理员手机号列表，用于后台管理权限

---

## 🧪 测试验证

### 1. 开发环境测试

在开发环境下，如果短信发送失败，系统会自动降级为开发模式：
- 验证码会在控制台输出
- 前端仍然可以正常使用

### 2. 生产环境测试

1. 启动服务：`npm run dev`
2. 访问登录页面：`http://localhost:3000/login`
3. 输入手机号，点击 **"获取验证码"**
4. 检查手机是否收到短信
5. 输入验证码，点击 **"登录/注册"**

---

## 💰 费用说明

### 短信价格

- **国内短信**：约 **0.04-0.06 元/条**
- **验证码短信**：通常有优惠，约 **0.04 元/条**

### 计费方式

- 按实际发送量计费
- 发送失败不收费
- 支持预付费和后付费

### 成本控制建议

1. **设置发送频率限制**：已实现 60 秒内只能发送一次
2. **验证码有效期**：已设置为 5 分钟
3. **监控发送量**：定期查看短信服务控制台的发送统计

---

## 🔍 常见问题

### Q1: 短信发送失败，提示 "InvalidAccessKeyId"

**原因**：AccessKey ID 或 Secret 配置错误

**解决**：
1. 检查 `.env.local` 中的配置是否正确
2. 确认 AccessKey 是否已启用
3. 重新生成 AccessKey 并更新配置

---

### Q2: 短信发送失败，提示 "SignatureDoesNotMatch"

**原因**：签名计算错误（通常是 Secret 配置错误）

**解决**：
1. 检查 `ALIYUN_SMS_ACCESS_KEY_SECRET` 是否正确
2. 确认 Secret 没有多余的空格或换行

---

### Q3: 短信发送失败，提示 "InvalidSignName"

**原因**：短信签名未审核通过或签名名称不匹配

**解决**：
1. 检查签名是否已审核通过
2. 确认 `ALIYUN_SMS_SIGN_NAME` 与审核通过的签名名称完全一致（包括空格、标点）

---

### Q4: 短信发送失败，提示 "InvalidTemplateCode"

**原因**：短信模板 CODE 错误或模板未审核通过

**解决**：
1. 检查模板是否已审核通过
2. 确认 `ALIYUN_SMS_TEMPLATE_CODE` 格式正确（`SMS_xxxxx`）
3. 确认模板类型为 **"验证码"**

---

### Q5: 短信发送失败，提示 "Throttling"

**原因**：发送频率过高，触发限流

**解决**：
1. 等待一段时间后重试
2. 检查代码中的频率限制逻辑
3. 联系阿里云客服提升限流阈值

---

### Q6: 开发环境如何测试？

**方案一**：使用真实短信服务（推荐）
- 配置真实的 AccessKey 和模板
- 直接发送真实短信

**方案二**：开发模式降级
- 如果短信发送失败，系统会自动降级
- 验证码会在控制台输出
- 前端仍然可以正常使用

---

## 📚 参考文档

- [阿里云短信服务文档](https://help.aliyun.com/product/44282.html)
- [短信服务 API 参考](https://help.aliyun.com/document_detail/101414.html)
- [签名审核规范](https://help.aliyun.com/document_detail/108253.html)
- [模板审核规范](https://help.aliyun.com/document_detail/108252.html)

---

## ✅ 配置检查清单

- [ ] 已获取 AccessKey ID 和 Secret
- [ ] 已开通短信服务
- [ ] 已申请并审核通过短信签名
- [ ] 已申请并审核通过短信模板
- [ ] 已配置 `.env.local` 环境变量
- [ ] 已测试短信发送功能
- [ ] 已测试登录/注册流程

---

配置完成后，您的用户就可以通过手机号+验证码的方式登录和注册了！🎉
