# 问题记录：文案和图片生成失败

## 问题描述（2024-12-XX）

1. **第一篇文案解析失败**：
   - `title` 显示为 "文案生成中..."（兜底方案）
   - `body` 包含 JSON 代码块字符串，而不是解析后的正文
   - 例如：`body: "```json\n{\n  \"title\": \"...\",\n  \"body\": \"...\"`

2. **图片生成不出来**：
   - 可能是文案生成失败导致后续流程中断

## 根本原因

1. **`extractJson` 函数问题**：
   - 虽然能提取 Markdown 代码块中的 JSON，但如果 JSON 内容不完整（被截断），解析会失败
   - 如果解析出的 JSON 没有 `title` 字段，会走兜底逻辑
   - 兜底逻辑中，如果 `titleMatch1` 找不到，`copy1` 会是 `null`，导致使用"文案生成中..."

2. **兜底逻辑不完善**：
   - 当 JSON 解析失败时，没有尝试从 JSON 代码块字符串中直接提取字段
   - 导致即使有 JSON 代码块，也无法提取出内容

## 修复方案

### 1. 增强 `extractJson` 函数
- ✅ 优先提取 Markdown 代码块中的 JSON（```json ... ```）
- ✅ 支持修复常见的 JSON 格式问题（尾随逗号、单引号等）
- ✅ 更详细的错误日志

### 2. 改进兜底逻辑
- ✅ 当 JSON 解析失败时，尝试从 JSON 代码块字符串中直接提取字段（使用正则表达式）
- ✅ 即使解析失败，也能从 JSON 代码块字符串中提取 `title`、`body`、`tags`
- ✅ 确保即使解析失败也能提取出基本内容，避免显示"文案生成中..."

### 3. 添加详细日志
- ✅ 记录原始内容和清理后的内容
- ✅ 记录解析结果（成功/失败）
- ✅ 记录解析后的标题、正文长度、标签数量

## 避免再次出现的措施

1. **代码审查检查点**：
   - ✅ 确保 `extractJson` 函数能处理各种 JSON 格式（Markdown 代码块、纯 JSON、不完整的 JSON）
   - ✅ 确保兜底逻辑能处理所有可能的失败情况
   - ✅ 添加详细的日志，便于定位问题

2. **测试检查点**：
   - ✅ 测试 JSON 解析成功的情况
   - ✅ 测试 JSON 解析失败但能从代码块字符串中提取的情况
   - ✅ 测试完全无法提取的情况（应该使用合理的兜底方案）

3. **代码规范**：
   - ✅ 所有解析逻辑都应该有兜底方案
   - ✅ 兜底方案不应该显示"文案生成中..."这样的占位符，应该尝试提取实际内容
   - ✅ 添加详细的日志，便于调试

## 修复后的代码位置

- `web/src/app/api/generate/copy/route.ts`:
  - `extractJson` 函数（第29-65行）
  - 第一篇文案解析逻辑（第375-410行）
  - 第二篇文案解析逻辑（第423-458行）

